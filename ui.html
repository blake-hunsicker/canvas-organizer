<script src="https://unpkg.com/phosphor-icons"></script>

<!-- Canvas controls -->
<div class="canvas-controls">
  <button class="direction-control horizontal active"><i class="ph-arrow-right"></i></button>
  <button class="direction-control vertical"><i class="ph-arrow-down"></i></button>
</div>

<!-- Map nodes -->
<div class="map"></div>

<!-- Update and cancel buttons -->
<button id="cancel">Cancel</button>
<button id="update">Update Canvas</button>

<script src="https://cdn.jsdelivr.net/npm/@shopify/draggable@1.0.0-beta.11/lib/sortable.js"></script>
<script>

  // Function to toggle flex direction
  document.querySelectorAll('.direction-control').forEach(div =>
    div.onclick = () => {
      if (div.classList.contains('active')) {
        return
      } else {
        // Toggle direction in 2 steps:
        let activeButton = document.querySelector('.direction-control.active')

        // Toggle active classes
        activeButton.classList.remove('active')
        div.classList.add('active')

        // Toggle flex direction in .map
        if (document.querySelector('.direction-control.active').classList.contains('horizontal')) {
          document.querySelector('.map').style.flexDirection = 'row'
        } else {
          document.querySelector('.map').style.flexDirection = 'column'
        }
      }
    }
  )

  // Initiate Draggable library
  const sortable = new Sortable.default(document.querySelectorAll('.map'), {
    draggable: '.node-thumbnail'
  });

  // Function to clear all child nodes
  function removeAllChildNodes(parent) {
    while (parent.firstChild) {
      parent.removeChild(parent.firstChild)
    }
  }

  onmessage = (event) => {

    let message = event.data.pluginMessage

    if (message.selection) {

      let selectedNodes = message.selection
      let mapContainer = document.querySelector('.map')

      // Clear previous selections
      removeAllChildNodes(mapContainer)

      // Cycle through nodes and add them to the DOM
      let i

      for (i = 0; i <= selectedNodes.length - 1; i++) {
        console.log(selectedNodes[i])
        
        // Creating the layer name
        const nodeName = document.createElement('div')
        nodeName.className = 'node-name'
        nodeName.innerText = selectedNodes[i].name

        // Creating the layer image
        const nodeImg = document.createElement('div')
        nodeImg.className = 'node-img'
        if (selectedNodes[i].type == 'FRAME') {
          nodeImg.innerHTML = '<i class="ph-hash-straight"></i>'
        } else if (selectedNodes[i].type == 'COMPONENT' || selectedNodes[i].type == 'COMPONENT_SET') {
          nodeImg.innerHTML = '<i class="ph-diamonds-four-fill"></i>'
        } else if (selectedNodes[i].type == 'INSTANCE') {
          nodeImg.innerHTML = '<i class="ph-diamond"></i>'
        } else if (selectedNodes[i].type == 'TEXT') {
          nodeImg.innerHTML = '<i class="ph-text-t-fill"></i>'
        }
        nodeImg.style.height = '120px' // selectedNodes[i].height / 4
        nodeImg.style.width = '120px' // selectedNodes[i].width / 4

        // Creating the thumbnail wrapper + append all above elements to it
        const nodeThumbnail = document.createElement('div')
        nodeThumbnail.className = 'node-thumbnail'
        nodeThumbnail.appendChild(nodeImg)
        nodeThumbnail.appendChild(nodeName)
        
        // Append thumbnail wrapper to DOM
        mapContainer.appendChild(nodeThumbnail)
      }

    }

  }

</script>

<!-- CSS -->
<style>
  body {
    color: var(--figma-color-text);
    background-color: var(--figma-color-bg-secondary);
  }
  .map {
    display: flex;
    flex-direction: row;
  }
  .direction-control.active {
    background-color: blue;
  }
</style>
